<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Propuesta de Cambios - Drivers Falabella</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#f7f8fa; padding:20px; color:#222; }
    .card { background:#fff; border-radius:12px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.08); max-width:900px; margin:auto; }
    h1 { font-size:1.3rem; margin-bottom:12px; }
    select, button, input {
      padding:8px 12px; border-radius:8px; border:1px solid #ccc; font-size:14px;
    }
    button { background:#4f46e5; color:white; border:none; cursor:pointer; }
    button:disabled { background:#999; cursor:not-allowed; }
    table { border-collapse:collapse; width:100%; margin-top:16px; }
    th, td { border:1px solid #ddd; padding:6px 8px; text-align:center; }
    th { background:#f0f0f5; }
    td[contenteditable="true"] { background:#fffdf0; }
    td:focus { outline:2px solid #4f46e5; background:#eef; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Propuesta de Cambios - Drivers</h1>

    <div style="margin-bottom:12px;">
      <label>Token de acceso:</label>
      <input id="tokenInput" placeholder="Ej: abc123-juan" style="width:220px;"/>
      <button onclick="guardarToken()">Ingresar</button>
    </div>

    <div style="margin-bottom:12px;">
      <label>Orden:</label>
      <select id="ordenSelect"><option value="">--Seleccione--</option></select>
      <label style="margin-left:12px;">Driver:</label>
      <select id="driverSelect"><option value="">--Seleccione--</option></select>
      <button id="cargarBtn" onclick="cargarDriver()">Cargar</button>
    </div>

    <div id="tablaContainer"></div>
    <div style="margin-top:12px;">
      <button id="enviarBtn" disabled>Enviar propuesta</button>
    </div>
  </div>

  <script>
    const API_URL = "https://drivers-api-xxxxx-southamerica-west1.run.app"; // tu URL real de Cloud Run
    let API_KEY = "";
    let dataEmpresas = [];
    let ordenSel = "", driverSel = "";

    function guardarToken() {
      API_KEY = document.getElementById("tokenInput").value.trim();
      if (!API_KEY) return alert("Ingrese un token válido.");
      alert("Token guardado. Cargando base...");
      cargarCatalogo();
    }

    async function cargarCatalogo() {
      const res = await fetch(`${API_URL}/drivers-disponibles`, {
        headers: { "Authorization": "Bearer " + API_KEY }
      });
      if (!res.ok) return alert("Error cargando catálogo");
      const data = await res.json();
      const ordenes = [...new Set(data.map(d => d.orden_estadistica))];
      const ordenSelect = document.getElementById("ordenSelect");
      ordenSelect.innerHTML = "<option value=''>--Seleccione--</option>" +
        ordenes.map(o => `<option>${o}</option>`).join("");

      const driverSelect = document.getElementById("driverSelect");
      ordenSelect.addEventListener("change", () => {
        const seleccionada = ordenSelect.value;
        const drivers = data.filter(d => d.orden_estadistica === seleccionada).map(d => d.nombre_driver);
        driverSelect.innerHTML = "<option value=''>--Seleccione--</option>" +
          drivers.map(d => `<option>${d}</option>`).join("");
      });
    }

    async function cargarDriver() {
      ordenSel = document.getElementById("ordenSelect").value;
      driverSel = document.getElementById("driverSelect").value;
      if (!ordenSel || !driverSel) return alert("Seleccione orden y driver.");

      const res = await fetch(`${API_URL}/mis-drivers?orden=${encodeURIComponent(ordenSel)}&driver=${encodeURIComponent(driverSel)}`, {
        headers: { "Authorization": "Bearer " + API_KEY }
      });
      if (!res.ok) return alert("Error al cargar driver.");
      const data = await res.json();

      dataEmpresas = data.empresas;
      renderTabla();
    }

    function renderTabla() {
      let html = "<table><tr><th>Empresa</th><th>Porcentaje Actual</th><th>Nuevo (%)</th></tr>";
      dataEmpresas.forEach((e, i) => {
        html += `<tr>
          <td>${e.empresa}</td>
          <td>${e.porcentaje}</td>
          <td contenteditable="true" data-index="${i}">${e.porcentaje}</td>
        </tr>`;
      });
      html += "</table>";
      document.getElementById("tablaContainer").innerHTML = html;
      document.getElementById("enviarBtn").disabled = false;

      document.querySelectorAll("td[contenteditable]").forEach(td => {
        td.addEventListener("input", () => {
          const idx = parseInt(td.dataset.index);
          const val = parseFloat(td.innerText) || 0;
          dataEmpresas[idx].nuevo = val;
        });
      });

      document.getElementById("enviarBtn").onclick = enviarPropuesta;
    }

    async function enviarPropuesta() {
      const total = dataEmpresas.reduce((s,e) => s + (e.nuevo ?? e.porcentaje), 0);
      if (total > 100.001) return alert(`El total (${total.toFixed(2)}%) supera 100%`);

      const payload = {
        orden_estadistica: ordenSel,
        nombre_driver: driverSel,
        empresas: dataEmpresas.map(e => ({
          empresa: e.empresa,
          porcentaje_nuevo: e.nuevo ?? e.porcentaje
        }))
      };

      const res = await fetch(`${API_URL}/proponer-cambio`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + API_KEY
        },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!res.ok) return alert("Error: " + (data.detail || res.statusText));
      alert("Propuesta enviada correctamente. ID: " + data.propuesta_id);
    }
  </script>
</body>
</html>
