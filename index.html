<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Editor Drivers Falabella</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#f7f8fa; padding:20px; color:#222; }
    .card { background:#fff; border-radius:12px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.08); max-width:1000px; margin:auto; }
    h1 { font-size:1.3rem; margin:0 0 12px; }
    input[type="file"], button {
      padding:8px 12px; border-radius:8px; border:1px solid #ccc; font-size:14px;
    }
    button { background:#4f46e5; color:white; border:none; cursor:pointer; }
    button:disabled { background:#aaa; cursor:not-allowed; }

    .scroll-list { border:1px solid #ccc; border-radius:8px; max-height:140px; overflow-y:auto; padding:6px; background:#fff; margin:6px 0; }
    .scroll-item { padding:6px; border-radius:6px; cursor:pointer; }
    .scroll-item:hover { background:#f0f0f5; }
    .scroll-item.active { background:#4f46e5; color:white; }

    table { border-collapse:collapse; width:100%; margin-top:16px; }
    th, td { border:1px solid #ddd; padding:6px 8px; text-align:center; }
    th { background:#f0f0f5; }
    td[contenteditable="true"] { background:#fffdf0; }
    td:focus { outline:2px solid #4f46e5; background:#eef; }
    #warning { color:#b91c1c; font-weight:bold; margin-top:8px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Editor de Drivers (Distribución por Empresa)</h1>
    <input type="file" id="fileInput" accept=".xlsx,.xls" />
    <div style="margin-top:12px;">
      <strong>Órdenes Estadísticas</strong>
      <div id="ordenList" class="scroll-list"></div>
      <strong>Drivers</strong>
      <div id="driverList" class="scroll-list"></div>
      <button id="nuevoDriverBtn" disabled>Agregar Driver</button>
    </div>
    <button id="downloadBtn" disabled>Descargar Excel modificado</button>
    <div id="warning"></div>
    <table id="table"></table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    let workbook, fullData = [], empresasCols = [], headers = [];
    let ordenSeleccionada = "", driverSeleccionado = "";

    const fileInput = document.getElementById("fileInput");
    const ordenList = document.getElementById("ordenList");
    const driverList = document.getElementById("driverList");
    const nuevoDriverBtn = document.getElementById("nuevoDriverBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const table = document.getElementById("table");
    const warning = document.getElementById("warning");

    // --- Cargar Excel ---
    fileInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const arrayBuffer = await file.arrayBuffer();
      workbook = XLSX.read(arrayBuffer, { type: "array" });
      const ws = workbook.Sheets[workbook.SheetNames[0]];
      fullData = XLSX.utils.sheet_to_json(ws, { defval: "" });
      if (fullData.length === 0) return alert("El Excel está vacío.");

      headers = Object.keys(fullData[0]);
      empresasCols = headers.filter(h => h.toLowerCase().startsWith("empresa"));

      const ordenes = [...new Set(fullData.map(r => r.OrdenEstadistica))].sort();
      ordenList.innerHTML = ordenes.map(o => `<div class="scroll-item" data-orden="${o}">${o}</div>`).join("");
      driverList.innerHTML = "";
      table.innerHTML = "";
      downloadBtn.disabled = false;

      ordenList.querySelectorAll(".scroll-item").forEach(el => {
        el.addEventListener("click", () => {
          ordenSeleccionada = el.dataset.orden;
          document.querySelectorAll("#ordenList .scroll-item").forEach(x => x.classList.remove("active"));
          el.classList.add("active");
          renderDrivers();
        });
      });
    });

    // --- Renderizar lista de drivers ---
    function renderDrivers() {
      const drivers = [...new Set(fullData.filter(r => r.OrdenEstadistica === ordenSeleccionada).map(r => r.NombreDriver))].sort();
      driverList.innerHTML = drivers.map(d => `<div class="scroll-item" data-driver="${d}">${d}</div>`).join("");
      nuevoDriverBtn.disabled = false;
      table.innerHTML = "";
      driverList.querySelectorAll(".scroll-item").forEach(el => {
        el.addEventListener("click", () => {
          driverSeleccionado = el.dataset.driver;
          document.querySelectorAll("#driverList .scroll-item").forEach(x => x.classList.remove("active"));
          el.classList.add("active");
          renderTable();
        });
      });
    }

    // --- Agregar nuevo driver ---
    nuevoDriverBtn.addEventListener("click", () => {
      if (!ordenSeleccionada) return alert("Seleccione una orden primero.");
      const nombre = prompt("Ingrese el nombre del nuevo driver:");
      if (!nombre) return;
      const nuevaFila = { OrdenEstadistica: ordenSeleccionada, NombreDriver: nombre };
      empresasCols.forEach(c => nuevaFila[c] = 0);
      fullData.push(nuevaFila);
      renderDrivers();
    });

    // --- Renderizar tabla editable ---
    function renderTable() {
      const row = fullData.find(r => r.OrdenEstadistica === ordenSeleccionada && r.NombreDriver === driverSeleccionado);
      if (!row) return alert("No se encontró combinación.");

      let html = "<tr><th>Empresa</th><th>Porcentaje (%)</th></tr>";
      empresasCols.forEach(emp => {
        html += `<tr><td>${emp}</td><td contenteditable="true" data-col="${emp}">${row[emp] || 0}</td></tr>`;
      });
      table.innerHTML = html;

      table.querySelectorAll("td[contenteditable=true]").forEach(td => {
        td.addEventListener("input", () => {
          const col = td.dataset.col;
          const val = parseFloat(td.innerText.replace('%','')) || 0;
          row[col] = val;
          validarPorcentajeTotal(row);
        });
      });

      validarPorcentajeTotal(row);
    }

    // --- Validar que el total no supere 100 ---
    function validarPorcentajeTotal(row) {
      const total = empresasCols.reduce((s, c) => s + (parseFloat(row[c]) || 0), 0);
      if (total > 100.001) {
        warning.textContent = `⚠️ El total (${total.toFixed(2)}%) supera el 100%. Corrige los valores.`;
        warning.style.color = "#b91c1c";
        downloadBtn.disabled = true;
      } else {
        warning.textContent = `Total actual: ${total.toFixed(2)}%`;
        warning.style.color = "#16a34a";
        downloadBtn.disabled = false;
      }
    }

    // --- Descargar Excel modificado ---
    downloadBtn.addEventListener("click", () => {
      const ws = XLSX.utils.json_to_sheet(fullData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Drivers");
      XLSX.writeFile(wb, "drivers_modificado.xlsx");
    });
  </script>
</body>
</html>
